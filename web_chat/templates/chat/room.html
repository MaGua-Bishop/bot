<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Room</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f8f9fa;
            position: relative;
        }

        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px;
            text-align: center;
            font-size: 1.8em;
            font-weight: bold;
            z-index: 1;
        }

        .chat-log {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 80px;
            background-color: #e9ecef;
            z-index: 0;
        }

        .message {
            display: flex;
            align-items: flex-start;
            margin: 12px 0;
        }

        .message.self {
            flex-direction: row-reverse;
        }

        .message .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 12px;
            object-fit: cover;
        }

        .message .content-box {
            max-width: 80%;
            display: flex;
            flex-direction: column;
        }

        .message .meta {
            font-size: 1em;
            color: #666;
            margin-bottom: 5px;
        }

        .message .content {
            padding: 12px;
            border-radius: 15px;
            line-height: 1.6;
            font-size: 1.1em;
            background-color: #ffffff;
            text-align: left;
        }

        .message.self .content {
            background-color: #d1e7ff;
            text-align: right;
        }

        .chat-footer {
            padding: 10px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            border-top: 1px solid #ddd;
            position: fixed;
            bottom: 0;
            width: 100%;
            z-index: 2;
        }

        .form-control {
            border-radius: 25px;
            border: 1px solid #ccc;
            padding: 12px;
            font-size: 1.1em;
            width: 100%;
            margin-right: 5px;
        }

        .btn-send, .btn-attach {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            padding: 10px;
            font-size: 1.1em;
            width: 45px;
            height: 45px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
        }

        .btn-attach {
            background-color: #6c757d;
        }

        #chat-file-input {
            display: none;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 576px) {
            .message .avatar {
                width: 45px;
                height: 45px;
            }

            .message .content-box {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
<div class="chat-container">
    <div class="chat-header">ç•ªæ‘Šæœºå™¨äºº</div>
    <div id="chat-log" class="chat-log"></div>
    <div class="chat-footer">
        <label for="chat-file-input" class="btn-attach">ğŸ“</label>
        <input type="file" id="chat-file-input" accept="image/*,video/*">
        <input id="chat-message-input" type="text" class="form-control" placeholder="è¯·åœ¨è¿™é‡Œè¾“å…¥ä¿¡æ¯">
        <button id="chat-message-submit" class="btn-send">â¤</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function () {
        const userName = new URLSearchParams(window.location.search).get('user') || 'Anonymous';
        const userAvatar = "https://lh3.googleusercontent.com/a/ALm5wu2Vm-KiLrLQW9QfemC-QvUWqJpuOha8VDg7m70D=k-s48";
        const adminId = "{{ admin_id }}";  // ä»åç«¯è·å–admin_id

        console.log("åˆå§‹åŒ–è¿æ¥:");
        console.log("- ç”¨æˆ·å:", userName);
        console.log("- Admin ID:", adminId);

        // ä¿®æ”¹WebSocketè¿æ¥URLï¼Œæ·»åŠ admin_idå‚æ•°
        const chatSocket = new WebSocket(
            `${window.location.origin.replace('http', 'ws')}/ws/chat/?admin=${adminId}`
        );

        chatSocket.onopen = function () {
            console.log(`WebSocketè¿æ¥å·²å»ºç«‹ï¼Œæˆ¿é—´ID: chat_room_${adminId}`);
        };

        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            console.log("æ”¶åˆ°WebSocketæ¶ˆæ¯:", data);

            displayMessage(data);
        };

        function getCurrentTime() {
            return new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
        }

        function displayMessage(data) {
            console.log("æ˜¾ç¤ºæ¶ˆæ¯:", data);  // æ·»åŠ æ—¥å¿—
            
            const messageClass = data.user === userName ? 'self' : 'other';
            const avatar = data.avatar || userAvatar;
            const isImage = data.file_type && data.file_type.startsWith('image/');
            const isVideo = data.file_type && data.file_type.startsWith('video/');
            const contentText = data.message || '';

            console.log("æ¶ˆæ¯ç±»å‹:", {isImage, isVideo, hasText: !!contentText});  // æ·»åŠ æ—¥å¿—

            // è·å–æ˜¾ç¤ºçš„ç”¨æˆ·å
            const displayName = data.user_name || data.user || 'Anonymous';

            let mediaContent = '';
            if (isImage) {
                mediaContent = `<img src="${data.file_url}" alt="Image" class="media-content"
                                 style="width: 150px; border-radius: 8px; margin-top: 5px; object-fit: cover;"
                                 ondblclick="openFullImage('${data.file_url}')">`;
            } else if (isVideo) {
                mediaContent = `<video src="${data.file_url}" controls class="media-content"
                                 style="width: 150px; border-radius: 8px; margin-top: 5px; object-fit: cover;"></video>`;
            }

            console.log("ç”Ÿæˆçš„åª’ä½“å†…å®¹:", mediaContent);  // æ·»åŠ æ—¥å¿—

            const messageHTML = `
                <div class="message ${messageClass}">
                    <img src="${avatar}" alt="Avatar" class="avatar">
                    <div class="content-box">
                        <div class="meta">${displayName} â€¢ ${data.timestamp || getCurrentTime()}</div>
                        ${mediaContent}
                        ${contentText ? `<div class="content" style="margin-top: 5px;">${contentText}</div>` : ''}
                    </div>
                </div>`;

            $("#chat-log").append(messageHTML);
            $("#chat-log").scrollTop($("#chat-log")[0].scrollHeight);
        }

        function openFullImage(url) {
            window.open(url, '_blank');
        }

        async function loadHistory() {
            try {
                const response = await $.get(`/get_messages/?admin=${adminId}`);
                console.log("åŠ è½½å†å²æ¶ˆæ¯:", response);  // æ·»åŠ æ—¥å¿—
                response.forEach(data => {
                    displayMessage(data);
                });
            } catch (error) {
                console.error("åŠ è½½å†å²æ¶ˆæ¯å¤±è´¥:", error);
            }
        }

        function sendMessage() {
            const message = $("#chat-message-input").val().trim();
            if (message === '') return;

            const messageData = {
                user: userName,
                user_name: userName,
                message: message,
                admin_username: adminId,
                avatar: userAvatar,
                timestamp: getCurrentTime()
            };

            if (chatSocket.readyState === WebSocket.OPEN) {
                // ä¿å­˜åˆ°æ•°æ®åº“
                $.ajax({
                    url: '/save_message/',
                    type: 'POST',
                    data: JSON.stringify(messageData),
                    contentType: 'application/json',
                    success: function (response) {
                        console.log("æ¶ˆæ¯å·²ä¿å­˜:", response);
                        if (response.status === 'success') {
                            // ä½¿ç”¨response.messageè€Œä¸æ˜¯messageData
                            displayMessage(response.message);
                            chatSocket.send(JSON.stringify(response.message));
                            $("#chat-message-input").val('');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("ä¿å­˜æ¶ˆæ¯å¤±è´¥:", error);
                    }
                });
            } else {
                console.error("WebSocketæœªè¿æ¥");
            }
        }

        function sendFileMessage(file) {
            const formData = new FormData();
            formData.append('file', file);

            $.ajax({
                url: '/upload/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    console.log("æ–‡ä»¶ä¸Šä¼ æˆåŠŸ:", response);
                    
                    const messageData = {
                        user: userName,
                        user_name: userName,
                        file_url: response.file_url,
                        file_type: file.type,
                        admin_username: adminId,
                        avatar: userAvatar,
                        timestamp: getCurrentTime()
                    };

                    console.log("å‡†å¤‡å‘é€æ–‡ä»¶æ¶ˆæ¯:", messageData);

                    // ä¿å­˜æ–‡ä»¶æ¶ˆæ¯åˆ°æ•°æ®åº“
                    $.ajax({
                        url: '/save_message/',
                        type: 'POST',
                        data: JSON.stringify(messageData),
                        contentType: 'application/json',
                        success: function (res) {
                            console.log("æ–‡ä»¶æ¶ˆæ¯å·²ä¿å­˜:", res);
                            if (res.status === 'success') {
                                // åªå‘é€WebSocketæ¶ˆæ¯ï¼Œä¸è°ƒç”¨displayMessage
                                chatSocket.send(JSON.stringify(res.message));
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("ä¿å­˜æ–‡ä»¶æ¶ˆæ¯å¤±è´¥:", error);
                        }
                    });
                },
                error: function (xhr, status, error) {
                    console.error("æ–‡ä»¶ä¸Šä¼ å¤±è´¥:", error);
                }
            });
        }

        $("#chat-file-input").change(function (e) {
            const file = e.target.files[0];
            if (file) {
                sendFileMessage(file);
            }
        });

        // ç»‘å®šäº‹ä»¶å¤„ç†å™¨
        $("#chat-message-submit").click(sendMessage);
        $("#chat-message-input").keypress(function (e) {
            if (e.which == 13) {
                sendMessage();
            }
        });

        // åŠ è½½å†å²æ¶ˆæ¯
        loadHistory();
    });
</script>
</body>
</html>
</html>
